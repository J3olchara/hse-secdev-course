name: NFR Tests

on:
  pull_request:
    paths:
      - 'app/**'
      - 'tests/nfr/**'
      - 'requirements*.txt'
  push:
    branches: [main]
  workflow_dispatch:  # ручной запуск если нужно

permissions:
  contents: read

concurrency:
  group: nfr-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quick-nfr:
    name: Quick NFR Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Run quick NFR tests
        run: |
          # запускаем только быстрые тесты
          pytest tests/nfr/ -v -m "nfr and not slow" --tb=short
        timeout-minutes: 5

  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Run performance tests
        run: |
          pytest tests/nfr/test_performance.py -v --tb=short
        timeout-minutes: 10

  security:
    name: Security Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Run security tests
        run: |
          pytest tests/nfr/test_security.py -v --tb=short
        timeout-minutes: 10

  reliability:
    name: Reliability Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Run reliability tests
        run: |
          pytest tests/nfr/test_reliability.py -v --tb=short
        timeout-minutes: 10

  scalability:
    name: Scalability Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Run scalability tests
        run: |
          pytest tests/nfr/test_scalability.py -v --tb=short
        timeout-minutes: 15

  full-nfr:
    name: Full NFR Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [quick-nfr, performance, security, reliability, scalability]
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Run all NFR tests including slow tests
        run: |
          pytest tests/nfr/ -v --tb=short --durations=10
        timeout-minutes: 25

      - name: Generate NFR report
        if: always()
        run: |
          echo "## NFR Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All NFR tests completed" >> $GITHUB_STEP_SUMMARY
