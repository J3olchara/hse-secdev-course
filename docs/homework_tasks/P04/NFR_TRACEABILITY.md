# NFR — Матрица трассируемости (Traceability Matrix)

Связь между рисками (R), нефункциональными требованиями (NFR) и методами верификации.

## Легенда
- **F**: Поток данных (из DFD)
- **R**: Риск (из реестра рисков)
- **NFR**: Нефункциональное требование (из P03/NFR.md)
- **Артефакт**: Конкретный тест/документ для верификации

## Матрица трассируемости

| Риск/R | NFR-01 | NFR-02 | NFR-03 | NFR-04 | NFR-05 | NFR-06 | NFR-07 | NFR-08 | NFR-09 | NFR-10 | Артефакт верификации |
|--------|--------|--------|--------|--------|--------|--------|--------|--------|--------|--------|---------------------|
| **R1** Брутфорс атаки | ● |   | ● |   |   | ● |   |   |   |   | Интеграционные тесты аутентификации + penetration testing |
| **R2** SQL injection |   | ● |   |   |   |   |   | ● |   |   | Unit тесты валидации + SQL injection scanning |
| **R3** Компрометация JWT |   |   |   | ● | ● |   |   |   |   |   | Аудит управления секретами + тесты ротации ключей |
| **R4** Несанкционированный доступ |   |   |   |   | ● |   | ● |   |   |   | Авторизационные unit тесты + тесты с невалидными токенами |
| **R5** DDoS атака |   |   | ● |   |   | ● |   |   |   |   | Нагрузочный тест (p95 ≤ 300мс) + симуляция DDoS |
| **R6** Утечка PII данных | ● |   |   |   |   |   | ● |   |   |   | Аудит безопасности БД + GDPR compliance check |
| **R7** Вредоносный контент |   | ● |   |   |   |   | ● | ● | ● |   | Unit тесты с malicious payloads + content scanning |
| **R8** Отсутствие аудита |   |   |   |   |   |   |   |   |   | ● | Анализ логов безопасности + проверка целостности бэкапов |
| **R9** Переполнение БД |   |   | ● |   |   | ● |   |   |   |   | Тестирование производительности + cleanup политики |
| **R10** Утечка деталей ошибок |   | ● |   |   |   |   |   |   |   |   | Контракт тесты ошибок + аудит логов |

## Детализация покрытия

### NFR-01: Хранение паролей (Argon2id)
**Покрываемые риски:** R1, R6
- **R1**: Защищает от брутфорс атак через сильное хэширование
- **R6**: Обеспечивает безопасное хранение PII данных

**Артефакты:**
- Конфигурация `argon2-cffi` с параметрами t=3, m=256MB, p=1
- Unit тесты хэширования паролей
- Penetration testing аутентификации

### NFR-02: Ошибки в формате RFC7807
**Покрываемые риски:** R2, R7, R10
- **R2**: Предотвращает утечку деталей через валидацию ввода
- **R7**: Маскирует PII в ответах об ошибках
- **R10**: Стандартизированные сообщения без деталей реализации

**Артефакты:**
- Контракт тесты всех эндпоинтов
- E2E тесты обработки ошибок
- Correlation ID во всех ответах

### NFR-03: Производительность аутентификации (p95 ≤ 300мс)
**Покрываемые риски:** R1, R5, R9
- **R1**: Обеспечивает быструю реакцию на атаки
- **R5**: Поддерживает доступность под нагрузкой
- **R9**: Предотвращает деградацию от перегрузки

**Артефакты:**
- Нагрузочный тест с Locust (50 RPS)
- Мониторинг p95 перцентиля
- Авто-scaling политики

### NFR-04: Уязвимости зависимостей (High/Critical в 7 дней)
**Покрываемые риски:** R3
- **R3**: Защищает от компрометации через уязвимые JWT библиотеки

**Артефакты:**
- CI отчет SCA (Safety/SBOM)
- Автоматическое обновление зависимостей
- Emergency process для critical уязвимостей

### NFR-05: Ротация секретов (каждые 30 дней)
**Покрываемые риски:** R3, R4
- **R3**: Предотвращает долгосрочную компрометацию ключей
- **R4**: Обеспечивает актуальность авторизации

**Артефакты:**
- Vault/KMS интеграция для ротации
- Журнал ротации секретов
- Тесты перехода между ключами

### NFR-06: Rate limiting аутентификации (≤5 попыток/мин/IP)
**Покрываемые риски:** R1, R5, R9
- **R1**: Основная защита от брутфорс атак
- **R5**: Предотвращает DoS на аутентификацию
- **R9**: Ограничивает нагрузку от одного пользователя

**Артефакты:**
- Интеграционные тесты rate limiting
- Мониторинг блокировок IP
- CAPTCHA интеграция

### NFR-07: Шифрование данных в покое (AES-256 для PII)
**Покрываемые риски:** R4, R6, R7
- **R4**: Защищает данные в БД от несанкционированного доступа
- **R6**: Основная защита от утечек PII
- **R7**: Шифрует чувствительный контент

**Артефакты:**
- Database encryption audit
- PII detection и классификация
- Content encryption policies

### NFR-08: Валидация входных данных (100% параметров)
**Покрываемые риски:** R2, R7
- **R2**: Предотвращает инъекции через строгие проверки
- **R7**: Блокирует вредоносный контент на входе

**Артефакты:**
- Unit тесты всех валидаторов
- Fuzzing тестирование ввода
- Input sanitization rules

### NFR-09: Security headers (A+ rating)
**Покрываемые риски:** R7
- **R7**: Защищает от XSS через правильные заголовки

**Артефакты:**
- SecurityHeaders.com скан
- OWASP ZAP тестирование
- HSTS preload список

### NFR-10: Аудит действий пользователей
**Покрываемые риски:** R8
- **R8**: Обеспечивает traceability всех изменений

**Артефакты:**
- Structured logging всех операций
- Log retention policies
- Audit trail integrity checks

## Статус покрытия рисков

✅ **Полностью покрытые (все риски):** 10/10 рисков имеют хотя бы одно NFR
✅ **Критические риски покрытые:** R1-R7 (7/7) имеют соответствующие NFR
✅ **Артефакты определены:** Каждый NFR имеет конкретные методы верификации

## Следующие шаги
1. **Реализовать missing артефакты** для каждого NFR
2. **Добавить тесты** для всех указанных артефактов
3. **Интегрировать верификацию** в CI/CD pipeline
4. **Проводить регулярные аудиты** соответствия NFR
