# NFR_BDD.md — BDD-сценарии приёмки для требований безопасности

## Feature: Безопасность аутентификации (NFR-01, NFR-06)

  Scenario: Успешная аутентификация с правильными учетными данными
    Given пользователь зарегистрирован в системе с паролем, хэшированным Argon2id
    And пользователь предоставляет правильные учетные данные
    When выполняется POST запрос на /auth/login
    Then возвращается статус 200 OK с JWT токеном
    And токен действителен в течение 30 минут

  Scenario: Защита от брутфорс атак (Rate limiting)
    Given настроено ограничение в 5 попыток входа в минуту с одного IP
    And злоумышленник пытается войти с неправильными учетными данными
    When выполняется более 5 POST запросов на /auth/login за минуту с одного IP
    Then первые 5 запросов возвращают статус 401 Unauthorized
    And последующие запросы возвращают статус 429 Too Many Requests
    And IP блокируется на 15 минут

  Scenario: Блокировка подозрительной активности
    Given пользователь пытается войти с неправильным паролем 3 раза
    When выполняется четвертая попытка входа с тем же IP
    Then возвращается статус 429 с сообщением о необходимости CAPTCHA
    And дальнейшие попытки требуют решения CAPTCHA

## Feature: Производительность аутентификации (NFR-03)

  Scenario: p95 время ответа аутентификации под нагрузкой
    Given сервис развернут на stage окружении
    And настроена нагрузка в 50 RPS на эндпоинт /auth/login
    When запускается 5-минутный нагрузочный тест
    Then p95 время ответа не превышает 300 миллисекунд
    And среднее время ответа менее 150 миллисекунд
    And количество ошибок сервера менее 1%

## Feature: Стандартизация ошибок (NFR-02)

  Scenario: Ошибки аутентификации в формате RFC7807
    Given API настроен для возврата ошибок в формате RFC7807
    When выполняется запрос с неправильными учетными данными на /auth/login
    Then возвращается статус 401 Unauthorized
    And тело ответа содержит:
      | type | https://tools.ietf.org/html/rfc7807 |
      | title | Unauthorized |
      | status | 401 |
      | correlation_id | уникальный идентификатор |

  Scenario: Маскировка чувствительной информации в ошибках
    Given в системе хранится пароль пользователя
    When происходит ошибка аутентификации
    Then в ответе не содержится:
      | пароль пользователя |
      | хэш пароля |
      | внутренние детали системы |

  Scenario: Correlation ID для отслеживания запросов
    Given каждый запрос получает уникальный correlation_id
    When происходит любая ошибка API
    Then в ответе присутствует поле correlation_id
    And correlation_id логируется в системе для отладки

## Feature: Валидация входных данных (NFR-08)

  Scenario: Предотвращение SQL injection
    Given пользователь пытается ввести вредоносные данные
    When выполняется запрос с payload содержащим SQL injection:
      | ' OR '1'='1 |
      | '; DROP TABLE users; -- |
    Then запрос отклоняется с ошибкой валидации 422
    And база данных остается в целостном состоянии

  Scenario: Строгая валидация всех параметров
    Given настроены строгие правила валидации для всех эндпоинтов
    When выполняется запрос с некорректными данными:
      | пустое имя пользователя |
      | слишком длинный пароль (>72 символа) |
      | некорректный формат email |
    Then возвращается статус 422 Unprocessable Entity
    And указывается конкретное поле с ошибкой валидации

## Feature: Безопасность зависимостей (NFR-04)

  Scenario: Автоматическое обнаружение уязвимостей
    Given настроен CI/CD pipeline с инструментами безопасности
    When в зависимостях обнаруживается High/Critical уязвимость
    Then автоматически создается issue в репозитории
    And команда получает уведомление по email/Slack
    And уязвимость должна быть устранена в течение 7 дней

  Scenario: Регулярное сканирование зависимостей
    Given настроен ежедневный скан зависимостей
    When запускается nightly сборка
    Then генерируется отчет безопасности (SBOM)
    And отчет публикуется в артефакты сборки
    And критические уязвимости блокирую сборку
