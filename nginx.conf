events {
  worker_connections 1024;
}

http {
  upstream app {
    server app:8000;
  }

  server {
    listen 80;
    server_name localhost;

    client_max_body_size 10M;

    location / {
      proxy_pass http://app;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }
  }
}

Вот название и описание PR для задания P06:

---

## Название PR:
```
[P06] Secure Coding - контроли безопасного кодирования и негативные тесты
```

---

Реализация ключевых контролей безопасного кодирования (P06) для устранения уязвимостей и улучшения валидации ввода. Исправлены реальные уязвимости в модуле wishes (DoS через пагинацию, wildcard injection в поиске), добавлена защита от ошибок округления при работе с деньгами, маскирование PII в логах.

Связано с NFR-02, NFR-06, NFR-08 (P03) и угрозами STRIDE D/T (P04).

## Что сделано

### 1. Валидация и нормализация ввода (NFR-08)
- Добавлено поле `price: Decimal` в модель Wish для безопасной работы с денежными значениями (precision=12, scale=2)
- Установлен `extra='forbid'` во всех Pydantic схемах (защита от mass assignment)
- Добавлена автоматическая нормализация datetime в UTC
- Усилена валидация длин строк с граничными значениями

### 2. Защита от DoS через пагинацию (NFR-06, STRIDE D)
- Ограничение `skip <= 10000` (защита от deep pagination)
- Ограничение `limit <= 50` (было 100)
- Ограничение длины поискового запроса `<= 100` символов
- Документация в docstring с обоснованием лимитов

### 3. Защита от wildcard injection (NFR-08, STRIDE T)
- Функция `escape_like_pattern()` для экранирования спецсимволов SQL LIKE (%, _, [, ], \)
- Применена к методу `search_by_title()` в WishRepository
- Предотвращает злоупотребление wildcard символами для DoS

### 4. Улучшение RFC7807 с маскированием PII (NFR-02)
- Создана централизованная карта ошибок (`app/core/error_codes.py`)
- Утилиты для маскирования PII (`app/utils/pii_masking.py`): email, пароли, токены
- Автоматическое маскирование PII в логах через middleware
- Улучшенный формат ошибок с `description` из карты кодов

### 5. Инфраструктура
- Настроен Alembic для миграций БД
- Создана миграция для добавления поля `price`
- Автоматический запуск миграций в docker-compose
- Добавлен nginx reverse proxy
- Создан Makefile с командами `run`, `test`, `update`

### 6. Документация
- ADR-005: Input Validation Improvements (полная документация всех решений)
- Связь с NFR-02, NFR-06, NFR-08 и STRIDE D/T

### 7. Тесты (≥8 негативных)
- 25 негативных тестов в `tests/unit/test_secure_coding_fixes.py`:
 - `test_decimal_precision_attack` — попытка передать огромное число
 - `test_negative_price_rejected` — отрицательная цена
 - `test_price_with_too_many_decimals` — >2 знаков после запятой
 - `test_extra_fields_forbidden_*` — дополнительные поля запрещены (3 теста)
 - `test_search_sql_wildcard_injection_*` — экранирование спецсимволов (5 тестов)
 - `test_mask_email_*`, `test_mask_password`, `test_mask_token` — маскирование PII (9 тестов)
 - `test_datetime_timezone_normalization_*` — UTC нормализация (2 теста)
 - `test_search_length_limit_exceeded` — ограничение длины поиска

## Как проверял(а)
- [x] `ruff/black/isort` локально — все проходят без ошибок
- [x] `pytest -q` зелёный — 216/216 тестов passed
- [x] `pre-commit run --all-files` — не настроен в проекте

## Артефакты

### Изменённые файлы:
- `app/models/wish.py` — добавлено поле `price`
- `app/schemas/*.py` — `extra='forbid'`, UTC нормализация
- `app/repositories/wish.py` — защита от wildcard injection
- `app/api/v1/routers/wishes.py` — лимиты пагинации
- `app/middleware/error_handler.py` — маскирование PII
- `app/core/error_codes.py` — карта ошибок (новый файл)
- `app/utils/pii_masking.py` — утилиты маскирования (новый файл)

### Документация:
- `docs/adr/ADR-005-input-validation-improvements.md` — полная документация решений

### Тесты:
- `tests/unit/test_secure_coding_fixes.py` — 25 негативных тестов

### Инфраструктура:
- `alembic.ini`, `alembic/env.py`, `alembic/script.py.mako` — настройка Alembic
- `alembic/versions/*_add_price_field.py` — миграция для поля price
- `docker-compose.yaml` — автоматические миграции, nginx
- `nginx.conf` — конфигурация reverse proxy
- `Makefile` — команды run/test/update

## Критерии выполнения (★★2 проектный уровень)

- C1: Исправлены реальные уязвимости в модуле wishes (DoS, wildcard injection)
- C2: Минимум 25 негативных тестов с покрытием всех контролей
- C3: Валидация адаптирована к домену (цены, поиск), маскирование PII
- C4: Линтеры проходят, CI зелёный (216 тестов passed)
- C5: Интеграция в рабочий модуль с привязкой к NFR и STRIDE

## Связь с предыдущими практиками
- NFR-02 (P03) → Улучшенный RFC7807 с картой ошибок и маскированием PII
- NFR-06 (P03) → Защита от DoS через ограничения пагинации
- NFR-08 (P03) → Строгая валидация всех входных данных
- STRIDE D (P04) → DoS атаки через пагинацию
- STRIDE T (P04) → Wildcard injection (tampering поисковых запросов)